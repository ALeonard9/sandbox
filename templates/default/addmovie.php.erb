<?php

session_start();
ob_start();

include '../connectToDB.php';

$imdbID = $_GET['imdbid'];
$movieTitle = $_GET['title'];
$api = "https://api.themoviedb.org/3/find/".$imdbID."?api_key=<%=node['projectorion']['tmdb_api_key'] %>&external_source=imdb_id";
$apiresponse =  file_get_contents($api);
$json = json_decode($apiresponse, true);
$poster_path =  $json['movie_results'][0]['poster_path'];
$poster = "https://image.tmdb.org/t/p/w185".$poster_path;
if ($poster == 'https://image.tmdb.org/t/p/w185') {
	$poster = 'https://upload.wikimedia.org/wikipedia/en/f/f9/No-image-available.jpg';
}
$user_id = $_SESSION['userid'];

$check = "SELECT * FROM orion.movies where imdb='".$imdbID."';";
$stmt = $db->prepare($check);
$stmt->execute();
$row = $stmt->fetch(PDO::FETCH_ASSOC);
if ( !$row){
	$sql = "INSERT INTO `orion`.`movies` (`imdb`, `title`, `poster_url`) VALUES ('$imdbID', '$movieTitle', '$poster');";
	$db->exec($sql);
	$movie_id =  $db->lastInsertId();
} else {
	$movie_id = $row['id'];
}

if (isset($_SESSION['userid']))
	{
		$sql = "INSERT INTO orion.g_user_movies (`user_id`, `movies_id`, `rank`, `completed`) VALUES ('$user_id', '$movie_id', '0', '1');";
		$db->exec($sql);
		header("Location: movie.php");
		exit;
	}
else
	{
	header("location: ../users/signin.php");
	}
?>
